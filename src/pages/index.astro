---
import { ProductList } from '@/components/products';
import Pagination from '@/components/shared/Pagination.astro';
import type { ProductWithImages } from '@/interfaces';
import MainLayout from '@/layouts/MainLayout.astro';
// import { getSession } from 'auth-astro/server';
import { actions } from 'astro:actions';

// const session = await getSession(Astro.request);

// const { user } = session ?? {};

const searchParams = Astro.url.searchParams;
const pageParam = Number(searchParams.get('page') ?? 1);

const { data, error } = await actions.getProductsByPage({
  page: pageParam,
  limit: 16,
});

const products: ProductWithImages[] = 
  (error || data.products.length === 0)
    ? []
    : data.products;

const totalPages = (error || data.totalPages === 0) ? 0 : data.totalPages;

if (products.length === 0) {
  return Astro.redirect(`/?page=${totalPages}`);
}
---

<MainLayout
  title="All Products - Astro Shop"
  description="Welcome to the home page"
  robots="index, follow"
  robots="index, follow"
>
  <div class="content">
    <h1>All Products</h1>
    <ProductList products={products} client:idle />
    <Pagination totalPages={totalPages} />
  </div>
</MainLayout>

